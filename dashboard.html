<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard - Niche Finder</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="assets/css/dash.css">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700;800;900&family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- CRITICAL: Scripts must load in this exact order -->
    
    <!-- 1. FIRST: Response Parser for JSON handling -->
    <script src="assets/js/response-parser.js"></script>
    
    <!-- 2. Core API utilities -->
    <script src="assets/js/api.js"></script>
    <script src="assets/js/theme.js"></script>
    
    <!-- 3. Page system core -->
    <script src="assets/js/pages.core.js"></script>
    <script src="assets/js/pages.modals.js"></script>
    
    <!-- 4. Navigation fix (before pages) -->
    <script src="assets/js/navigation-fix.js"></script>
    
    <!-- 5. Page modules (synchronous loading) -->
    <script src="assets/js/pages/dashboard.page.js"></script>
    <script src="assets/js/pages/opportunities.page.js"></script>
    <script src="assets/js/pages/topgigs.page.js"></script>
    <script src="assets/js/pages/cvanalysis.page.js"></script>
    <script src="assets/js/pages/filters.page.js"></script>
    <script src="assets/js/pages/history.page.js"></script>
    <script src="assets/js/pages/settings.page.js"></script>
    <script src="assets/js/pages/niches.page.js"></script>
    <script src="assets/js/pages/promotions.page.js"></script>
    
    <!-- Legacy compatibility -->
    <script src="assets/js/niches_page.js"></script>

</head>
<body>
    <!-- Background -->
    <div class="background">
        <div class="bubble bubble-1"></div>
        <div class="bubble bubble-2"></div>
        <div class="bubble bubble-3"></div>
    </div>

    <!-- Cursor Glow -->
    <div class="cursor-glow" id="cursorGlow"></div>

    <!-- Dashboard Layout -->
    <div class="dashboard">
        <!-- Sidebar -->
        <aside class="sidebar" id="sidebar">
            <div class="sidebar-logo">
                <div class="logo-icon">
                    <img src="assets/images/project-logo.png" alt="Niche Finder Logo">
                </div>
                <span class="sidebar-logo-text">Niche Finder</span>
            </div>

            <nav class="sidebar-nav">
                <a href="#" data-page="dashboard" class="nav-item active">
                    <i class="fas fa-th-large"></i>
                    <span>Dashboard</span>
                </a>
                
                <a href="#" data-page="opportunities" class="nav-item">
                    <i class="fas fa-briefcase"></i>
                    <span>Opportunities</span>
                </a>
                <a href="#" data-page="topgigs" class="nav-item">
                    <i class="fas fa-star"></i>
                    <span>Top Gigs</span>
                </a>
                <a href="#" data-page="cv-analysis" class="nav-item">
                    <i class="fas fa-file-pdf"></i>
                    <span>CV Analysis</span>
                </a>
                <a href="#" data-page="niches" class="nav-item">
                    <i class="fas fa-bullseye"></i>
                    <span>Niches</span>
                </a>
               
                <a href="#" data-page="settings" class="nav-item">
                    <i class="fas fa-cog"></i>
                    <span>Settings</span>
                </a>
                <a href="#" data-page="promotions" class="nav-item">
                    <i class="fas fa-gift"></i>
                    <span>Promotions</span>
                </a>
                <a href="#" data-page="complaints" class="nav-item">
                    <i class="fas fa-comments"></i>
                    <span>Complaints</span>
                </a>
                <a href="/admin/index.html" class="nav-item" id="adminNavLink" style="display: none;">
                    <i class="fas fa-shield-alt"></i>
                    <span>Admin Panel</span>
                </a>
            </nav>

            <!-- Upgrade Button / Tier Display -->
            <button class="upgrade-btn" id="upgradeBtn">
                <i class="fas fa-crown"></i>
                <span id="upgradeBtnText">Upgrade to Pro</span>
            </button>

            <div class="sidebar-user">
                <div class="user-avatar">JD</div>
                <div class="user-info">
                    <div class="user-name">John Doe</div>
                    <div class="user-email">john@example.com</div>
                </div>
                <button class="logout-btn-sidebar" onclick="logoutUser()" title="Logout">
                    <i class="fas fa-sign-out-alt"></i>
                </button>
            </div>
        </aside>

        <!-- Main Content -->
        <main class="main-content" id="mainContent">
            <!-- Top Header -->
            <header class="top-header" id="topHeader">
                <div class="header-left">
                    <button class="menu-toggle" id="menuToggle">
                        <i class="fas fa-bars"></i>
                    </button>
                    <div>
                        <h1 class="page-title">Dashboard</h1>
                        <div class="breadcrumb">
                            <span>Home</span> / Dashboard
                        </div>
                    </div>
                </div>

              

                <div class="header-right">
                    <div class="credits-display" id="creditsDisplay" style="
                        display: flex;
                        align-items: center;
                        gap: 8px;
                        padding: 8px 14px;
                        background: rgba(51, 51, 51, 0.2);
                        border: 1px solid rgba(255, 255, 255, 0.15);
                        border-radius: 12px;
                        margin-right: 16px;
                        cursor: pointer;
                        transition: all 0.3s ease;
                    " onmouseover="this.style.background='rgba(51, 51, 51, 0.4)'; this.style.borderColor='rgba(255, 255, 255, 0.25)'" onmouseout="this.style.background='rgba(51, 51, 51, 0.2)'; this.style.borderColor='rgba(255, 255, 255, 0.15)'" onclick="showCreditsInfo()">
                        <i class="fas fa-coins" style="color: #fbbf24;"></i>
                        <div style="display: flex; flex-direction: column; gap: 2px;">
                            <span style="font-size: 11px; color: rgba(255, 255, 255, 0.6); font-weight: 500;">Credits</span>
                            <span id="creditsValue" style="font-size: 14px; color: #FFFFFF; font-weight: 700;">--</span>
                        </div>
                    </div>
                   
                   
                </div>
            </header>

            <!-- Dashboard Content -->
            <div class="dashboard-content">
                <div class="dashboard-grid">
                    <!-- Stats Card 1 -->
                    <div class="glass-card stats-card" style="animation-delay: 0s;">
                        <div class="stats-header">
                            <div class="stats-icon">
                                <i class="fas fa-briefcase"></i>
                            </div>
                            
                        </div>
                        <div class="stats-value">247</div>
                        <div class="stats-label">Total Opportunities</div>
                        <div class="stats-description">Found this week</div>
                    </div>

                    <!-- Stats Card 2 -->
                    <div class="glass-card stats-card" style="animation-delay: 0.1s;">
                        <div class="stats-header">
                            <div class="stats-icon">
                                <i class="fas fa-bookmark"></i>
                            </div>
                            
                        </div>
                        <div class="stats-value">42</div>
                        <div class="stats-label">Saved Opportunities</div>
                        <div class="stats-description">Saved this month</div>
                    </div>

                    <!-- Stats Card 3 - Total Scans -->
                    <div class="glass-card stats-card" style="animation-delay: 0.2s;">
                        <div class="stats-header">
                            <div class="stats-icon">
                                <i class="fas fa-scanner"></i>
                            </div>
                            
                        </div>
                        <div class="stats-value" id="totalScansValue">0</div>
                        <div class="stats-label">Total Scans</div>
                        <div class="stats-description" id="totalScansDesc">Made in this account</div>
                    </div>

                    <!-- Scanner Card -->
                    <div class="glass-card large-card" style="animation-delay: 0.3s;">
                        <div class="card-header">
                            <h3 class="card-title">Opportunity Scanner</h3>
                            <div class="card-actions">
                               
                            </div>
                        </div>
                        
                        <!-- Scanner Interface -->
                        <div class="scanner-interface" id="scannerInterface">
                            <!-- Idle State -->
                            <div class="scanner-idle" id="scannerIdle">
                                <i class="fas fa-search" style="font-size: 48px; opacity: 0.3; margin-bottom: 20px;"></i>
                                <h4 style="font-size: 20px; font-weight: 700; margin-bottom: 12px;">Ready to Find Opportunities</h4>
                                <p style="font-size: 14px; color: rgba(255, 255, 255, 0.6); margin-bottom: 28px;">
                                    Scan multiple platforms for developer, designer, and freelance opportunities
                                </p>
                                <button class="start-scan-btn" id="startScanBtn">
                                    <i class="fas fa-play"></i>
                                    Start Scanning
                                </button>
                            </div>

                            <!-- Scanning State -->
                            <div class="scanner-active" id="scannerActive" style="display: none;">
                                <div class="scan-progress">
                                    <div class="scan-progress-bar">
                                        <div class="scan-progress-fill" id="scanProgressFill"></div>
                                    </div>
                                    <div style="display: flex; justify-content: space-between; align-items: center; margin-top: 12px;">
                                        <div class="scan-percentage" id="scanPercentage">0%</div>
                                        <div id="scanTimeDisplay" style="color: rgba(255, 255, 255, 0.7); font-size: 13px; font-weight: 600;">0m 0s</div>
                                    </div>
                                </div>

                                <div class="scan-log" id="scanLog">
                                    <!-- Scan messages will appear here -->
                                </div>

                                <div class="scan-summary" id="scanSummary" style="display: none;">
                                    <div class="summary-stat">
                                        <i class="fas fa-check-circle"></i>
                                        <div>
                                            <div class="summary-value" id="totalOpportunities">0</div>
                                            <div class="summary-label">Total Opportunities</div>
                                        </div>
                                    </div>
                                    <div class="summary-stat">
                                        <i class="fas fa-clock"></i>
                                        <div>
                                            <div class="summary-value" id="scanTime">0s</div>
                                            <div class="summary-label">Scan Time</div>
                                        </div>
                                    </div>
                                </div>

                                <button class="stop-scan-btn" id="stopScanBtn">
                                    <i class="fas fa-stop"></i>
                                    Stop Scanning
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- Activity Timeline -->
                    <div class="glass-card" style="animation-delay: 0.4s;">
                        <div class="card-header">
                            <h3 class="card-title">Recent Activity</h3>
                        </div>
                        <div class="activity-list">
                            <div class="activity-item">
                                <div class="activity-icon">
                                    <i class="fas fa-plus"></i>
                                </div>
                                <div class="activity-content">
                                    <div class="activity-title">New opportunity found</div>
                                    <div class="activity-description">Senior React Developer</div>
                                </div>
                                <div class="activity-time">2m ago</div>
                            </div>
                            <div class="activity-item">
                                <div class="activity-icon">
                                    <i class="fas fa-paper-plane"></i>
                                </div>
                                <div class="activity-content">
                                    <div class="activity-title">Application sent</div>
                                    <div class="activity-description">Web3 Designer role</div>
                                </div>
                                <div class="activity-time">15m ago</div>
                            </div>
                            <div class="activity-item">
                                <div class="activity-icon">
                                    <i class="fas fa-bell"></i>
                                </div>
                                <div class="activity-content">
                                    <div class="activity-title">WhatsApp notification</div>
                                    <div class="activity-description">3 new opportunities</div>
                                </div>
                                <div class="activity-time">1h ago</div>
                            </div>
                            <div class="activity-item">
                                <div class="activity-icon">
                                    <i class="fas fa-filter"></i>
                                </div>
                                <div class="activity-content">
                                    <div class="activity-title">Filter updated</div>
                                    <div class="activity-description">Added "blockchain" keyword</div>
                                </div>
                                <div class="activity-time">3h ago</div>
                            </div>
                            <div class="activity-item">
                                <div class="activity-icon">
                                    <i class="fas fa-rocket"></i>
                                </div>
                                <div class="activity-content">
                                    <div class="activity-title">Token launch detected</div>
                                    <div class="activity-description">New project on DexScreener</div>
                                </div>
                                <div class="activity-time">5h ago</div>
                            </div>
                        </div>
                    </div>

                  

                    <!-- Top Keywords -->
                    <div class="glass-card full-width" style="animation-delay: 0.8s;">
                        <div class="card-header">
                            <h3 class="card-title">Top Performing Keywords</h3>
                            <div class="card-actions">
                                <button class="card-filter">Last 30 Days</button>
                            </div>
                        </div>
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 16px; margin-top: 20px;">
                            <div style="padding: 20px; background: rgba(255, 255, 255, 0.04); border-radius: 12px; text-align: center;">
                                <div style="font-size: 32px; font-weight: 800; font-family: 'Poppins', sans-serif; margin-bottom: 8px;">87</div>
                                <div style="font-size: 14px; color: rgba(255, 255, 255, 0.6);">React Developer</div>
                            </div>
                            <div style="padding: 20px; background: rgba(255, 255, 255, 0.04); border-radius: 12px; text-align: center;">
                                <div style="font-size: 32px; font-weight: 800; font-family: 'Poppins', sans-serif; margin-bottom: 8px;">65</div>
                                <div style="font-size: 14px; color: rgba(255, 255, 255, 0.6);">Web3 Designer</div>
                            </div>
                            <div style="padding: 20px; background: rgba(255, 255, 255, 0.04); border-radius: 12px; text-align: center;">
                                <div style="font-size: 32px; font-weight: 800; font-family: 'Poppins', sans-serif; margin-bottom: 8px;">52</div>
                                <div style="font-size: 14px; color: rgba(255, 255, 255, 0.6);">Community Manager</div>
                            </div>
                            <div style="padding: 20px; background: rgba(255, 255, 255, 0.04); border-radius: 12px; text-align: center;">
                                <div style="font-size: 32px; font-weight: 800; font-family: 'Poppins', sans-serif; margin-bottom: 8px;">43</div>
                                <div style="font-size: 14px; color: rgba(255, 255, 255, 0.6);">Blockchain Dev</div>
                            </div>
                            <div style="padding: 20px; background: rgba(255, 255, 255, 0.04); border-radius: 12px; text-align: center;">
                                <div style="font-size: 32px; font-weight: 800; font-family: 'Poppins', sans-serif; margin-bottom: 8px;">38</div>
                                <div style="font-size: 14px; color: rgba(255, 255, 255, 0.6);">Marketing Lead</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- Upgrade Modal -->
    <div class="modal-overlay" id="upgradeModal">
        <div class="modal-content" style="max-width: 100%; width: 90%; max-height: 90vh; overflow-y: auto; border-radius: 20px;">
            <button class="modal-close" id="modalClose" style="top: 16px; right: 16px; z-index: 10;">
                <i class="fas fa-times"></i>
            </button>

            <div style="padding: 24px 20px; text-align: center;">
                <h2 class="modal-title" style="font-size: clamp(22px, 5vw, 32px); margin-bottom: 8px;">Upgrade Your Plan</h2>
                <p class="modal-subtitle" style="font-size: clamp(13px, 3.5vw, 15px); margin-bottom: 24px;">Choose the perfect plan for your needs</p>

                <!-- 2x2 Grid for Mobile, Responsive -->
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(min(100%, 200px), 1fr)); gap: 16px; margin-bottom: 24px;">
                    <!-- Free Plan -->
                    <div class="pricing-card-compact" style="
                        background: linear-gradient(135deg, rgba(107, 114, 128, 0.1) 0%, rgba(107, 114, 128, 0.05) 100%);
                        border: 1px solid rgba(107, 114, 128, 0.2);
                        border-radius: 16px;
                        padding: 20px;
                        text-align: center;
                        cursor: pointer;
                        transition: all 0.3s ease;
                        position: relative;
                        overflow: hidden;
                    " onclick="this.style.transform='scale(1.02)'; setTimeout(() => this.style.transform='scale(1)', 200);">
                        <div style="font-size: 24px; margin-bottom: 12px;">üéØ</div>
                        <h3 style="color: white; font-size: 16px; font-weight: 700; margin: 0 0 4px 0;">Free</h3>
                        <div style="color: rgba(255, 255, 255, 0.6); font-size: 12px; margin-bottom: 12px;">Current Plan</div>
                        <div style="color: #10b981; font-size: 18px; font-weight: 800; margin-bottom: 16px;">$0<span style="font-size: 12px;">/mo</span></div>
                        <button style="width: 100%; padding: 10px; background: rgba(255, 255, 255, 0.1); border: 1px solid rgba(255, 255, 255, 0.2); border-radius: 8px; color: rgba(255, 255, 255, 0.5); cursor: not-allowed; font-size: 12px; font-weight: 600; opacity: 0.6;">Active</button>
                    </div>

                    <!-- Pro Plan -->
                    <div class="pricing-card-compact" style="
                        background: linear-gradient(135deg, rgba(59, 130, 246, 0.15) 0%, rgba(59, 130, 246, 0.08) 100%);
                        border: 2px solid rgba(59, 130, 246, 0.4);
                        border-radius: 16px;
                        padding: 20px;
                        text-align: center;
                        cursor: pointer;
                        transition: all 0.3s ease;
                        position: relative;
                        animation: pulse-card 2s ease-in-out infinite;
                        transform: scale(1.05);
                    " onclick="this.style.animation='none'; setTimeout(() => this.style.animation='pulse-card 2s ease-in-out infinite', 500);">
                        <div style="position: absolute; top: 8px; right: 8px; background: #3b82f6; color: white; padding: 4px 8px; border-radius: 6px; font-size: 10px; font-weight: 700;">‚≠ê Popular</div>
                        <div style="font-size: 28px; margin-bottom: 12px; margin-top: 4px;">üëë</div>
                        <h3 style="color: white; font-size: 16px; font-weight: 700; margin: 0 0 4px 0;">Pro</h3>
                        <div style="color: #3b82f6; font-size: 12px; margin-bottom: 12px;">Most Popular</div>
                        <div style="color: #3b82f6; font-size: 20px; font-weight: 800; margin-bottom: 16px;">$29<span style="font-size: 12px;">/mo</span></div>
                        <button onclick="upgradeUser('pro')" style="width: 100%; padding: 10px; background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%); border: none; border-radius: 8px; color: white; cursor: pointer; font-size: 12px; font-weight: 700; transition: all 0.3s ease;" onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 8px 16px rgba(59, 130, 246, 0.3)'" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='none'">Upgrade Now</button>
                    </div>

                    <!-- Ultra Plan -->
                    <div class="pricing-card-compact" style="
                        background: linear-gradient(135deg, rgba(168, 85, 247, 0.1) 0%, rgba(168, 85, 247, 0.05) 100%);
                        border: 1px solid rgba(168, 85, 247, 0.3);
                        border-radius: 16px;
                        padding: 20px;
                        text-align: center;
                        cursor: pointer;
                        transition: all 0.3s ease;
                        position: relative;
                    " onclick="this.style.transform='scale(1.02)'; setTimeout(() => this.style.transform='scale(1)', 200);">
                        <div style="font-size: 28px; margin-bottom: 12px;">üöÄ</div>
                        <h3 style="color: white; font-size: 16px; font-weight: 700; margin: 0 0 4px 0;">Ultra</h3>
                        <div style="color: rgba(255, 255, 255, 0.6); font-size: 12px; margin-bottom: 12px;">Maximum Power</div>
                        <div style="color: #a855f7; font-size: 20px; font-weight: 800; margin-bottom: 16px;">$79<span style="font-size: 12px;">/mo</span></div>
                        <button onclick="upgradeUser('ultra')" style="width: 100%; padding: 10px; background: linear-gradient(135deg, #a855f7 0%, #9333ea 100%); border: none; border-radius: 8px; color: white; cursor: pointer; font-size: 12px; font-weight: 700; transition: all 0.3s ease;" onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 8px 16px rgba(168, 85, 247, 0.3)'" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='none'">Upgrade Now</button>
                    </div>

                    <!-- Premium Plan -->
                    <div class="pricing-card-compact" style="
                        background: linear-gradient(135deg, rgba(249, 115, 22, 0.1) 0%, rgba(249, 115, 22, 0.05) 100%);
                        border: 1px solid rgba(249, 115, 22, 0.3);
                        border-radius: 16px;
                        padding: 20px;
                        text-align: center;
                        cursor: pointer;
                        transition: all 0.3s ease;
                        position: relative;
                    " onclick="this.style.transform='scale(1.02)'; setTimeout(() => this.style.transform='scale(1)', 200);">
                        <div style="font-size: 28px; margin-bottom: 12px;">üíé</div>
                        <h3 style="color: white; font-size: 16px; font-weight: 700; margin: 0 0 4px 0;">Premium</h3>
                        <div style="color: rgba(255, 255, 255, 0.6); font-size: 12px; margin-bottom: 12px;">Enterprise</div>
                        <div style="color: #f97316; font-size: 20px; font-weight: 800; margin-bottom: 16px;">Custom<span style="font-size: 12px;">/mo</span></div>
                        <button onclick="contactSales()" style="width: 100%; padding: 10px; background: linear-gradient(135deg, #f97316 0%, #ea580c 100%); border: none; border-radius: 8px; color: white; cursor: pointer; font-size: 12px; font-weight: 700; transition: all 0.3s ease;" onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 8px 16px rgba(249, 115, 22, 0.3)'" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='none'">Contact Us</button>
                    </div>
                </div>

                <!-- Expandable Feature List -->
                <details style="background: rgba(255, 255, 255, 0.05); border: 1px solid rgba(255, 255, 255, 0.1); border-radius: 12px; padding: 16px; text-align: left; cursor: pointer;">
                    <summary style="color: white; font-weight: 600; display: flex; align-items: center; justify-content: space-between; user-select: none;">
                        <span>üìã View Feature Comparison</span>
                        <i class="fas fa-chevron-down" style="font-size: 12px;"></i>
                    </summary>
                    <div style="margin-top: 16px; font-size: 13px; color: rgba(255, 255, 255, 0.8);">
                        <div style="display: grid; grid-template-columns: 1fr 1fr 1fr 1fr; gap: 12px; margin-top: 12px;">
                            <div><strong>Free</strong><br>‚úì 1 niche<br>‚úì Basic platforms</div>
                            <div><strong style="color: #3b82f6;">Pro</strong><br>‚úì 5 niches<br>‚úì Advanced scraping</div>
                            <div><strong style="color: #a855f7;">Ultra</strong><br>‚úì Unlimited niches<br>‚úì All platforms</div>
                            <div><strong style="color: #f97316;">Premium</strong><br>‚úì Everything<br>‚úì 24/7 support</div>
                        </div>
                    </div>
                </details>
            </div>
        </div>

        <style>
            @keyframes pulse-card {
                0%, 100% { transform: scale(1.05); }
                50% { transform: scale(1.08); }
            }
            
            @keyframes shake {
                0%, 100% { transform: translateX(0); }
                25% { transform: translateX(-2px); }
                75% { transform: translateX(2px); }
            }
            
            @media (max-width: 640px) {
                .pricing-card-compact {
                    min-height: 180px;
                }
            }
        </style>
    </div>
<!-- Add this script in dashboard.html -->
<script>
async function loadUpgradeModal() {
    try {
        // Simplified modal - cards are already in HTML above
        console.log('Upgrade modal loaded');
    } catch (error) {
        console.error('Error loading upgrade modal:', error);
    }
}

async function upgradeUser(tier) {
    showToast(`Upgrading to ${tier}...`, 'info');
    try {
        // Call API to upgrade user
        const response = await API.upgradePlan(tier);
        if (response.success) {
            showToast(`Successfully upgraded to ${tier}!`, 'success');
            document.getElementById('upgradeModal').classList.remove('active');
            location.reload();
        }
    } catch (error) {
        showToast(`Upgrade failed: ${error.message}`, 'error');
    }
}

function contactSales() {
    showToast('Redirecting to contact page...', 'info');
    window.location.href = 'https://chat.whatsapp.com/JKMq6e8oMAuJ9CZzpTqlSo?mode=hqrt1';
}
</script>
            });
        }
        
        allPlans.forEach(plan => {
            const isCurrentPlan = plan.tier === user.tier;
            
            const card = document.createElement('div');
            card.className = 'pricing-modal-card' + (plan.tier === 'pro' ? ' featured' : '');
            // Store the full plan ID (use id, _id, or tier as fallback)
            card.dataset.planId = plan.id || plan._id || plan.tier;
            
            // Defensive price handling: price, price_ngn, or 0
            const price = plan.price ?? plan.price_ngn ?? 0;
            const priceDisplay = price === 0 ? 'Free' : `‚Ç¶${Number(price).toLocaleString()}/mo`;
            const badge = isCurrentPlan ? 'Current Plan' : (plan.tier === 'pro' ? 'Most Popular' : '');
            
            card.innerHTML = `
                ${badge ? `<span class="pricing-modal-badge">${badge}</span>` : ''}
                <h3 class="pricing-modal-name">${plan.tier.charAt(0).toUpperCase() + plan.tier.slice(1)}</h3>
                <div class="pricing-modal-price">${priceDisplay}</div>
                <ul class="pricing-modal-features">
                    <li><i class="fas fa-check"></i> ${plan.max_niches} niches</li>
                    <li><i class="fas fa-check"></i> ${plan.max_keywords_per_niche} keywords/niche</li>
                    <li><i class="fas fa-check"></i> ${plan.platforms.length} platforms</li>
                    <li><i class="fas fa-check"></i> ${plan.monthly_opportunities_limit === -1 ? 'Unlimited' : plan.monthly_opportunities_limit} opps/month</li>
                    ${plan.features ? plan.features.map(f => `<li><i class="fas fa-check"></i> ${f}</li>`).join('') : ''}
                </ul>
                <button class="pricing-modal-btn" 
                        ${isCurrentPlan ? 'disabled' : ''}
                        onclick="handleUpgradeClick(this)">
                    ${isCurrentPlan ? 'Current Plan' : `Upgrade to ${plan.tier.toUpperCase()}`}
                </button>
            `;
            
            modalContent.appendChild(card);
        });
    } catch (error) {
        console.error('Failed to load pricing:', error);
        document.querySelector('.pricing-modal-grid').innerHTML = `
            <div style="grid-column: 1/-1; text-align: center; padding: 40px;">
                <p>Failed to load pricing plans. Please try again.</p>
            </div>
        `;
    }
}

async function handleUpgradeClick(button) {
    // Get plan ID from the card's data attribute
    const card = button.closest('.pricing-modal-card');
    const planId = card.dataset.planId;
    const tierName = card.querySelector('.pricing-modal-name').textContent.toLowerCase();
    
    console.log('Upgrade clicked - Tier:', tierName, 'PlanId:', planId);
    
    await upgradeToPlan(tierName, planId, button);
}

async function upgradeToPlan(tier, planId, button) {
    let originalText = '';
    try {
        // Show loading state
        originalText = button.textContent;
        button.disabled = true;
        button.textContent = 'Processing...';
        
        console.log('Initializing payment for tier:', tier, 'planId:', planId);
        
        // Initialize payment with plan_id
        const response = await API.initializePayment(planId);
        
        console.log('Payment response:', response);
        
        // Check for success
        if (response.authorization_url) {
            // Redirect to Paystack
            window.location.href = response.authorization_url;
        } else if (response.detail) {
            throw new Error(response.detail);
        } else if (!response || Object.keys(response).length === 0) {
            throw new Error('Empty response from server');
        } else {
            throw new Error('No payment URL provided');
        }
    } catch (error) {
        console.error('Failed to initialize payment:', error);
        alert('Failed to initialize payment: ' + (error.message || 'Unknown error'));
        
        // Restore button state
        if (button && originalText) {
            button.disabled = false;
            button.textContent = originalText;
        }
    }
}

// Attach event listeners for upgrade buttons
document.addEventListener('DOMContentLoaded', () => {
    // Get all upgrade buttons by selecting them properly
    const upgradeButtons = document.querySelectorAll('.pricing-modal-btn');
    
    upgradeButtons.forEach(button => {
        // Skip disabled buttons (current plan)
        if (!button.disabled) {
            button.addEventListener('click', function(e) {
                e.preventDefault();
                
                // Get tier and planId from the parent card
                const card = this.closest('.pricing-modal-card');
                const tierName = card.querySelector('.pricing-modal-name').textContent.toLowerCase();
                const planId = card.dataset.planId || tierName;
                
                console.log('Upgrade clicked - Tier:', tierName, 'PlanId:', planId);
                
                upgradeToPlan(tierName, planId, this);
            });
        }
    });
});

// Call this when modal opens
if (document.getElementById('upgradeBtn')) {
    document.getElementById('upgradeBtn').addEventListener('click', () => {
        loadUpgradeModal();
        document.getElementById('upgradeModal').classList.add('active');
    });
}

// Follow Modal
async function initFollowModal() {
    try {
        const status = await API.checkFollowStatus();
        
        // Show modal if user hasn't followed and modal hasn't been dismissed
        if (status && !status.has_followed && !status.modal_dismissed) {
            showFollowModal();
        }
    } catch (error) {
        console.error('Failed to check follow status:', error);
    }
}

function showFollowModal() {
    const modalHTML = `
        <div id="followModal" class="follow-modal-overlay">
            <div class="follow-modal-content">
                <div class="follow-modal-header">
                    <h2>Stay Connected</h2>
                </div>
                
                <div class="follow-modal-body">
                    <div class="follow-icon">
                        <i class="fab fa-x-twitter"></i>
                    </div>
                    
                    <p class="follow-modal-text">
                        Follow our official X account to get exclusive updates, tips, and features first!
                    </p>
                    
                    <div class="follow-account">
                        <span class="follow-handle">@db0sz1</span>
                        <span class="follow-label">Get the latest updates</span>
                    </div>
                </div>
                
                <div class="follow-modal-actions">
                    <button id="dismissFollowBtn" class="follow-btn-dismiss" onclick="dismissFollowModal()">
                        Not now
                    </button>
                    <button id="followBtn" class="follow-btn-primary" onclick="openXFollow()">
                        <i class="fab fa-x-twitter"></i>
                        Follow @db0sz1
                    </button>
                </div>
            </div>
        </div>
    `;
    
    document.body.insertAdjacentHTML('beforeend', modalHTML);
    
    // Prevent closing by clicking outside
    document.getElementById('followModal').addEventListener('click', function(e) {
        if (e.target === this) {
            return false;
        }
    });
}

function openXFollow() {
    const xUrl = 'https://x.com/db0sz1';
    
    // Mark as followed and disable the button
    const followBtn = document.getElementById('followBtn');
    followBtn.disabled = true;
    followBtn.innerHTML = '<i class="fas fa-spinner"></i> Recording...';
    
    // Mark as followed in backend
    API.markFollowed().then(() => {
        followBtn.innerHTML = '<i class="fas fa-check"></i> I have followed';
        followBtn.classList.add('followed');
        
        // Open X in new tab
        window.open(xUrl, 'db0sz1', 'width=550,height=420');
        
        // Close modal after 2 seconds
        setTimeout(() => {
            const modal = document.getElementById('followModal');
            if (modal) {
                modal.style.opacity = '0';
                modal.style.transition = 'opacity 0.3s ease-out';
                setTimeout(() => modal.remove(), 300);
            }
        }, 2000);
    }).catch(error => {
        console.error('Failed to mark as followed:', error);
        followBtn.disabled = false;
        followBtn.innerHTML = '<i class="fab fa-x-twitter"></i> Follow @db0sz1';
        alert('Failed to record follow. Please try again.');
    });
}

async function dismissFollowModal() {
    try {
        await API.dismissFollowModal();
        
        const modal = document.getElementById('followModal');
        if (modal) {
            modal.style.opacity = '0';
            modal.style.transition = 'opacity 0.3s ease-out';
            setTimeout(() => modal.remove(), 300);
        }
    } catch (error) {
        console.error('Failed to dismiss modal:', error);
    }
}
</script>
    <script src="assets/js/dash.js"></script>
    
    <!-- Initialize Follow Modal on Load -->
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // Check follow status after auth is ready
            setTimeout(initFollowModal, 500);
            
            // Load total scans count
            loadTotalScans();
            
            // Check if user is admin and show admin link
            checkAdminStatus();
        });
        
        /**
         * Check if user is admin and show admin nav link if true
         */
        async function checkAdminStatus() {
            try {
                // First check if admin status is stored in localStorage (from login)
                const storedAdminStatus = localStorage.getItem('is_admin');
                console.log('Stored admin status from localStorage:', storedAdminStatus);
                
                let isAdmin = storedAdminStatus === 'true';
                
                // If not in localStorage, try to fetch from API
                if (!isAdmin) {
                    const response = await API.getCurrentUser();
                    console.log('Admin status check - API response:', response);
                    
                    // Check both is_admin and admin fields (API might use either)
                    isAdmin = response && (response.is_admin === true || response.admin === true);
                }
                
                console.log('Is user admin?', isAdmin);
                
                if (isAdmin) {
                    // Show admin nav link
                    const adminLink = document.getElementById('adminNavLink');
                    if (adminLink) {
                        adminLink.style.display = 'flex';
                        // Store admin status for later use
                        localStorage.setItem('is_admin', 'true');
                        console.log('‚úÖ Admin link shown');
                    } else {
                        console.warn('Admin link element not found');
                    }
                } else {
                    // Hide admin link and clear admin status
                    const adminLink = document.getElementById('adminNavLink');
                    if (adminLink) {
                        adminLink.style.display = 'none';
                    }
                    localStorage.removeItem('is_admin');
                    console.log('Admin link hidden - user not admin');
                }
            } catch (error) {
                console.error('Failed to check admin status:', error);
                // Hide admin link on error
                const adminLink = document.getElementById('adminNavLink');
                if (adminLink) {
                    adminLink.style.display = 'none';
                }
            }
        }
        
        async function loadTotalScans() {
            try {
                const result = await API.getDashboardStats();
                let totalScans = 0;
                
                // Extract monthly_scans from dashboard stats API response
                if (result && result.monthly_scans !== undefined) {
                    totalScans = result.monthly_scans;
                } else if (result && result.total) {
                    totalScans = result.total;
                } else if (result && Array.isArray(result.scans)) {
                    totalScans = result.scans.length;
                } else if (Array.isArray(result)) {
                    totalScans = result.length;
                }
                
                // Update the stats card
                const statsValue = document.getElementById('totalScansValue');
                const statsDesc = document.getElementById('totalScansDesc');
                
                if (statsValue) {
                    statsValue.textContent = totalScans;
                }
                if (statsDesc) {
                    statsDesc.textContent = totalScans === 1 ? 'Scan in this account' : 'Scans in this account';
                }
            } catch (error) {
                console.error('Failed to load total scans:', error);
                // Keep default 0 if error
                const statsValue = document.getElementById('totalScansValue');
                if (statsValue) {
                    statsValue.textContent = '0';
                }
            }
        }
    </script>

    <!-- Toast Container -->
    <div id="toastContainer" style="position: fixed; top: 20px; right: 20px; z-index: 10001; display: flex; flex-direction: column; gap: 12px; max-width: 400px;"></div>
</body>
</html>
